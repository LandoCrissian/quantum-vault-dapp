<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Quantum Vault</title>
  <meta name="theme-color" content="#00ffe1" />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #000;
      --card: rgba(255,255,255,0.03);
      --border: rgba(255,255,255,0.08);
      --accent: #00ffe1;
      --text: #fff;
      --subtext: #aaa;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Space Grotesk', sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 72px;
      background: #111;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      gap: 18px;
    }

    .sidebar .nav-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .sidebar .nav-icon svg {
      width: 22px;
      height: 22px;
      fill: #000;
    }

    /* Main layout */
    .main {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 20px;
      margin-bottom: 20px;
      backdrop-filter: blur(14px);
    }

    .title {
      font-size: 18px;
      color: var(--accent);
      margin-bottom: 10px;
    }

    .wallet {
      font-size: 13px;
      color: var(--subtext);
      margin-bottom: 8px;
      word-break: break-word;
    }

    .badge {
      display: inline-block;
      background: var(--accent);
      color: #000;
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 6px;
      margin: 4px;
      font-weight: bold;
    }

    .player-badge {
      display: flex;
      align-items: center;
      background: #111;
      border-radius: 14px;
      padding: 12px;
      margin-top: 10px;
      border: 2px solid var(--accent);
      cursor: pointer;
      position: relative;
    }

    .player-badge img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 12px;
      border: 2px solid inherit;
    }

    .badge-info {
      display: flex;
      flex-direction: column;
    }

    .nickname { color: var(--accent); font-weight: bold; }
    .handle { color: var(--subtext); font-size: 12px; }
    .badge-stats { font-size: 11px; color: var(--subtext); margin-top: 4px; }

    .balance-badges {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Chat styles */
    #chatBox {
      max-height: 220px;
      overflow-y: auto;
      font-size: 13px;
      background: #111;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
    }

    #chatInput {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #000;
      color: var(--accent);
    }

    #sendMsgBtn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: #000;
      font-weight: bold;
      margin-left: 8px;
    }

    /* Activity feed */
    #activityFeed .wallet {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--subtext);
    }

    /* Mobile tweaks */
    @media (max-width: 600px) {
      .sidebar { width: 60px; }
      .sidebar .nav-icon { width: 38px; height: 38px; }
      .sidebar .nav-icon svg { width: 18px; height: 18px; }
    }
  </style>
</head>
<body>
  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <div class="nav-icon" title="Home">
      <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    </div>
    <div class="nav-icon" title="Chat">
      <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <!-- Welcome & Badge -->
    <div class="section">
      <div class="title">Welcome Back</div>
      <div id="walletDisplay" class="wallet">Connecting...</div>
      <div class="player-badge" id="playerBadge">
        <img id="badgePFP" src="https://api.dicebear.com/6.x/pixel-art/svg?seed=anon" alt="PFP" />
        <div class="badge-info">
          <div class="nickname" id="badgeNickname">anon</div>
          <div class="handle" id="badgeHandle">ùïè: @handle</div>
          <div class="badge-stats">
            <span id="badgeGames">Games: 0</span>
            <span id="badgeWins">Wins: 0</span>
            <span id="badgeY2K">Y2K: 0</span>
          </div>
        </div>
      </div>
      <div class="balance-badges">
        <div id="y2kBalance" class="badge">Y2K: 0</div>
        <div id="croBalance" class="badge">CRO: 0</div>
      </div>
    </div>

    <!-- General Chat -->
    <div class="section">
      <div class="title">#general</div>
      <div id="chatBox">Loading chat...</div>
      <div style="display: flex;">
        <input type="text" id="chatInput" placeholder="Type your message..." />
        <button id="sendMsgBtn">Send</button>
      </div>
    </div>

    <!-- Activity Feed -->
    <div class="section">
      <div class="title">Vault Activity Feed</div>
      <div id="activityFeed">Loading activity...</div>
    </div>

    <!-- MVP Spotlight -->
    <div class="section">
      <div class="title">MVP Spotlight</div>
      <div id="mvpUser">@unknown</div>
      <div class="wallet" id="mvpEarnings">0 Y2K Earned</div>
    </div>

    <!-- Announcements -->
    <div class="section">
      <div class="title">Latest Announcement</div>
      <div id="latestAnnouncement">Loading...</div>
    </div>

    <!-- New Players -->
    <div class="section">
      <div class="title">New Players (Last 48h)</div>
      <div id="newPlayers">Loading...</div>
    </div>
  </div>

  <!-- Player Badge Edit Modal -->
<div class="modal" id="badgeModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:9999;">
  <div class="modal-content" style="background:#111; padding:24px; border-radius:14px; width:90%; max-width:360px; text-align:left; color:#fff; box-shadow:0 0 10px var(--accent);">
    <h2 style="color:var(--accent); font-size:18px; margin-bottom:16px;">Edit Player Badge</h2>
    
    <label for="editNickname" style="font-size:12px; color:#aaa;">Nickname</label>
    <input type="text" id="editNickname" placeholder="Enter nickname" style="width:100%; padding:10px; border-radius:8px; background:#000; border:1px solid #444; color:var(--accent); margin-top:4px;" />

    <label for="editHandle" style="font-size:12px; color:#aaa; margin-top:12px; display:block;">ùïè Handle</label>
    <input type="text" id="editHandle" placeholder="@handle" style="width:100%; padding:10px; border-radius:8px; background:#000; border:1px solid #444; color:var(--accent); margin-top:4px;" />

    <label for="editRimColor" style="font-size:12px; color:#aaa; margin-top:12px; display:block;">Badge Rim Color</label>
    <input type="color" id="editRimColor" value="#00ffe1" style="width:100%; height:40px; border:none; border-radius:8px; margin-top:4px;" />

    <div class="modal-actions" style="margin-top:16px; display:flex; justify-content:space-between;">
      <button class="save" id="saveBadgeBtn" style="padding:10px 20px; border-radius:10px; background:var(--accent); color:#000; font-weight:bold;">Save</button>
      <button class="cancel" id="cancelBadgeBtn" style="padding:10px 20px; border-radius:10px; background:#333; color:#fff;">Cancel</button>
    </div>
  </div>
</div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, collection, getDocs, query,
  orderBy, limit, where, onSnapshot, addDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCJwqDFZtf1PkZwAalOaf2_7eWtej5HIfA",
  authDomain: "y2k-arcade.firebaseapp.com",
  projectId: "y2k-arcade",
  storageBucket: "y2k-arcade.appspot.com",
  messagingSenderId: "1063043176357",
  appId: "1:1063043176357:web:20bc22e9cbf269ff40fa4c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let currentWallet = "";

async function connectWalletAndLoad() {
  if (!window.ethereum) {
    alert("Please install MetaMask");
    return;
  }

  const provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  const signer = provider.getSigner();
  currentWallet = (await signer.getAddress()).toLowerCase();

  const short = `${currentWallet.slice(0, 6)}...${currentWallet.slice(-4)}`;
  document.getElementById("walletDisplay").textContent = "Welcome back: " + short;

  const userSnap = await getDoc(doc(db, "users", currentWallet));
  if (userSnap.exists()) {
    const data = userSnap.data();
    document.getElementById("badgePFP").src = data.pfpUrl || `https://api.dicebear.com/6.x/pixel-art/svg?seed=anon`;
    document.getElementById("badgeNickname").textContent = data.username || "anon";
    document.getElementById("badgeHandle").textContent = data.xHandle ? `ùïè: @${data.xHandle}` : "ùïè: N/A";
    document.getElementById("badgeY2K").textContent = `Y2K: ${data.earnings || 0}`;
    document.getElementById("badgeGames").textContent = `Games: ${data.games || 0}`;
    document.getElementById("badgeWins").textContent = `Wins: ${data.wins || 0}`;
  }

  try {
    const croBal = await provider.getBalance(currentWallet);
    const cro = parseFloat(ethers.utils.formatEther(croBal)).toFixed(2);
    document.getElementById("croBalance").textContent = `CRO: ${cro}`;
  } catch {
    document.getElementById("croBalance").textContent = "CRO: --";
  }

  try {
    const y2kContract = new ethers.Contract(
      "0xB4Df7d2A736Cc391146bB0dF4277E8F68247Ac6d",
      ["function balanceOf(address) view returns (uint256)"],
      provider
    );
    const raw = await y2kContract.balanceOf(currentWallet);
    const bal = parseFloat(ethers.utils.formatUnits(raw, 18)).toFixed(2);
    document.getElementById("y2kBalance").textContent = `Y2K: ${bal}`;
  } catch {
    document.getElementById("y2kBalance").textContent = "Y2K: --";
  }
}

async function loadMVP() {
  const topSnap = await getDocs(query(collection(db, "users"), orderBy("earnings", "desc"), limit(1)));
  if (!topSnap.empty) {
    const top = topSnap.docs[0].data();
    document.getElementById("mvpUser").textContent = "@" + (top.username || "anon");
    document.getElementById("mvpEarnings").textContent = `${top.earnings || 0} Y2K Earned`;
  }
}

async function loadNewPlayers() {
  const cutoff = Date.now() - (48 * 60 * 60 * 1000);
  const q = query(collection(db, "users"), where("createdAt", ">", cutoff));
  const snap = await getDocs(q);
  const box = document.getElementById("newPlayers");
  box.innerHTML = snap.empty ? "No new users yet." : "";
  snap.forEach(doc => {
    const u = doc.data();
    const tag = document.createElement("div");
    tag.className = "badge";
    tag.textContent = "@" + (u.username || "anon");
    box.appendChild(tag);
  });
}

function loadActivityFeed() {
  const feed = document.getElementById("activityFeed");
  const q = query(collection(db, "activity_log"), orderBy("timestamp", "desc"), limit(8));

  onSnapshot(q, (snap) => {
    feed.innerHTML = snap.empty ? "No recent activity." : "";
    snap.forEach(doc => {
      const d = doc.data();
      const time = new Date(d.timestamp).toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
      });

      const item = document.createElement("div");
      item.className = "wallet";
      item.textContent = `@${d.username || "anon"} updated their badge at ${time}`;
      feed.appendChild(item);
    });
  });
}

// Real-time chat listener (general)
onSnapshot(
  query(collection(db, "chat"), orderBy("timestamp", "asc"), limit(100)),
  (snap) => {
    const box = document.getElementById("chatBox");
    box.innerHTML = "";
    snap.forEach(doc => {
      const m = doc.data();
      const msg = document.createElement("div");
      msg.innerHTML = `<strong style="color:var(--accent);">@${m.name || "anon"}:</strong> ${m.text}`;
      box.appendChild(msg);
    });
    box.scrollTop = box.scrollHeight;
  }
);

// Chat sender
document.getElementById("sendMsgBtn").addEventListener("click", async () => {
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if (!text) return;

  const name = document.getElementById("badgeNickname").textContent?.replace(/^@/, "") || "anon";

  await addDoc(collection(db, "chat"), {
    name,
    text,
    timestamp: serverTimestamp()
  });

  input.value = "";
});

connectWalletAndLoad();
loadMVP();
loadNewPlayers();
loadActivityFeed();

    // Edit modal trigger
document.getElementById("playerBadge").addEventListener("click", () => {
  document.getElementById("badgeModal").style.display = "flex";
});

// Live preview rim color
document.getElementById("editRimColor").addEventListener("input", () => {
  const color = document.getElementById("editRimColor").value;
  document.getElementById("playerBadge").style.borderColor = color;
  document.getElementById("badgePFP").style.borderColor = color;
});

// Cancel button
document.getElementById("cancelBadgeBtn").addEventListener("click", () => {
  document.getElementById("badgeModal").style.display = "none";
});

// Save badge logic
document.getElementById("saveBadgeBtn").addEventListener("click", async () => {
  const nickname = document.getElementById("editNickname").value.trim();
  const handle = document.getElementById("editHandle").value.trim();
  const rimColor = document.getElementById("editRimColor").value;

  try {
    await setDoc(doc(db, "users", currentWallet), {
      username: nickname,
      xHandle: handle,
      badgeColor: rimColor,
      lastUpdated: Date.now()
    }, { merge: true });

    await addDoc(collection(db, "activity_log"), {
      user: currentWallet,
      username: nickname || "anon",
      timestamp: Date.now()
    });

    document.getElementById("badgeNickname").textContent = nickname;
    document.getElementById("badgeHandle").textContent = handle ? `ùïè: @${handle}` : "ùïè: N/A";
    document.getElementById("playerBadge").style.borderColor = rimColor;
    document.getElementById("badgePFP").style.borderColor = rimColor;
    document.getElementById("badgeModal").style.display = "none";
  } catch (err) {
    console.error("Error saving badge:", err);
    alert("Failed to save. Try again.");
  }
});
   
</script>
  </body>
</html>
